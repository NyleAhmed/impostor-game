<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Impostor Word Game</title>

  <style>
    body { font-family: -apple-system, system-ui, Arial; margin: 0; background:#0b0f19; color:#fff; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 20px; }
    .card { background:#121a2a; border:1px solid #22304d; border-radius: 14px; padding: 16px; }
    h1 { font-size: 22px; margin: 0 0 12px; }
    label { display:block; margin: 12px 0 6px; color:#cbd5e1; font-size: 14px; }
    input {
      width: 100%; padding: 12px; border-radius: 10px;
      border:1px solid #2a3a5f; background:#0d1424; color:#fff; box-sizing: border-box;
    }
    button {
      width: 100%; padding: 12px; border-radius: 12px; border:0;
      background:#4f46e5; color:#fff; font-weight: 700; margin-top: 14px;
    }
    button.secondary { background:#22304d; font-weight: 600; }
    button:disabled { opacity: 0.55; }
    .hidden { display:none; }
    .center { text-align:center; }
    .big { font-size: 28px; margin: 10px 0; }
    .muted { color:#94a3b8; font-size: 14px; }
    .pill { display:inline-block; padding:6px 12px; border:1px solid #2a3a5f; border-radius:999px; color:#cbd5e1; font-size: 13px; }
    .nameRow { display:flex; gap:10px; align-items:center; margin-top:10px; }
    .nameRow .tag {
      width: 70px; min-width: 70px; text-align:center; padding:10px;
      border-radius:10px; border:1px solid #2a3a5f; background:#0d1424;
      font-size:13px; color:#cbd5e1;
    }
    .rules li { margin: 8px 0; color:#cbd5e1; }
    .revealBox { margin-top: 6px; padding: 14px; border-radius: 12px; border:1px solid #2a3a5f; background:#0d1424; }
    .revealText { font-size: 26px; margin: 6px 0; }
    .twoBtns { display:flex; gap:10px; }
    .twoBtns button { width: 100%; }

    /* Multi-category UI */
    .categoryGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
    .catItem {
      display:flex; gap:10px; align-items:center;
      padding:10px; border-radius:10px; border:1px solid #2a3a5f; background:#0d1424;
      cursor: pointer; user-select: none;
    }
    .catItem input { width: 18px; height: 18px; margin: 0; }
    .catItem span { color:#cbd5e1; font-size:14px; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- SETUP -->
  <div id="screen-setup" class="card">
    <h1>Impostor Word Game</h1>
    <p class="muted">Everyone gets the word — except one impostor.</p>

    <label>Categories (pick 1+)</label>
    <div id="categoryList" class="categoryGrid"></div>
    <p class="muted" style="margin-top:8px;">A random category will be chosen from your selections each round.</p>

<label>Number of players (3–8)</label>

<input
  id="players"
  type="number"
  min="3"
  max="8"
  step="1"
  inputmode="numeric"
  pattern="[0-9]*"
  value="5"
/>

<div class="twoBtns">
  <button type="button" id="minusBtn" class="secondary">−</button>
  <button type="button" id="plusBtn" class="secondary">+</button>
</div>

<div id="namesContainer"></div>

    <!-- ✅ NEW OPTION -->
    <label>Impostor Settings</label>
    <label class="catItem">
      <input type="checkbox" id="showCatToImpostor">
      <span>Show category to impostor</span>
    </label>

    <button id="startBtn">Start Round</button>
  </div>

  <!-- REVEAL -->
  <div id="screen-reveal" class="card hidden">
    <div class="center">
      <div class="pill" id="playerBadge"></div>
      <div class="big" id="revealTitle">Ready?</div>
      <p class="muted" id="revealHint">Press and hold to reveal. Release to hide.</p>
    </div>

    <div id="secretBox" class="revealBox hidden center">
      <div class="muted" id="secretSub"></div>
      <div class="revealText" id="secretMain"></div>
      <div class="muted" id="secretNote"></div>
    </div>

    <button id="revealBtn">Press & Hold to Reveal</button>
    <button id="hideBtn" class="secondary" disabled>Hide & Pass</button>
    <button id="backBtn1" class="secondary">Back to Setup</button>
  </div>

  <!-- RULES -->
  <div id="screen-rules" class="card hidden">
    <h1>Start Playing</h1>
    <div class="center">
      <div class="muted">Who goes first</div>
      <div id="firstSpeaker" class="big"></div>
      <p class="muted">Play the round in real life, then reveal the answer when you’re ready.</p>
    </div>

    <ul class="rules">
      <li>Everyone knows the word except the impostor.</li>
      <li>Go around and say <b>one short clue</b> related to the word.</li>
      <li>Don’t be too obvious.</li>
      <li>When you’re ready, vote in real life.</li>
    </ul>

    <button id="revealAnswerBtn">Reveal Answer</button>

    <div class="twoBtns">
      <button id="playAgainBtn" class="secondary">Play Again</button>
      <button id="backBtn2" class="secondary">Back</button>
    </div>
  </div>

  <!-- FINAL REVEAL -->
  <div id="screen-final" class="card hidden">
    <h1>Answer</h1>

    <div class="revealBox center">
      <div class="muted">The category was</div>
      <div id="finalCategory" class="big" style="font-size:22px;"></div>

      <div class="muted" style="margin-top:10px;">The word was</div>
      <div id="finalWord" class="big"></div>

      <div class="muted" style="margin-top:10px;">The impostor was</div>
      <div id="finalImpostor" class="big" style="font-size:22px;"></div>
    </div>

    <button id="playAgainBtn2">Play Again (new round)</button>
    <button id="backBtn3" class="secondary">Back to Setup</button>
  </div>

</div>

<script>
  // Loaded from words.json
  let WORDS = {};

  const $ = (id) => document.getElementById(id);
  const show = (id) => $(id).classList.remove("hidden");
  const hide = (id) => $(id).classList.add("hidden");

  let state = {
    players: 0,
    names: [],
    chosenCategory: "",
    word: "",
    impostor: 0,
    first: 0,
    current: 0,
    holding: false,
    holdTimer: null,
    showCategoryToImpostor: false // ✅ NEW
  };

  function rand(n) { return Math.floor(Math.random() * n); }

  async function loadWordPacks() {
    const res = await fetch("./words.json", { cache: "no-store" });
    if (!res.ok) throw new Error("Could not load words.json");
    WORDS = await res.json();
  }

  function initCategories() {
    const box = $("categoryList");
    box.innerHTML = "";

    const cats = Object.keys(WORDS);
    cats.forEach((cat, idx) => {
      const label = document.createElement("label");
      label.className = "catItem";
      label.innerHTML = `
        <input type="checkbox" class="catCheck" value="${cat}" ${idx < 2 ? "checked" : ""}>
        <span>${cat}</span>
      `;
      box.appendChild(label);
    });
  }

  function getSelectedCategories() {
    return Array.from(document.querySelectorAll(".catCheck:checked")).map(cb => cb.value);
  }

  function readExistingNameInputs() {
    const existing = [];
    let i = 0;
    while (true) {
      const el = document.getElementById("name_" + i);
      if (!el) break;
      existing.push(el.value);
      i++;
    }
    return existing;
  }

  function generateNames(preserveValues = true) {
    let n = parseInt($("players").value, 10);
    if (Number.isNaN(n)) n = 5;
    n = Math.max(3, Math.min(8, n));
    $("players").value = n;

    const prev = preserveValues ? readExistingNameInputs() : [];
    const box = $("namesContainer");
    box.innerHTML = "";

    for (let i = 0; i < n; i++) {
      const row = document.createElement("div");
      row.className = "nameRow";
      row.innerHTML = `
        <div class="tag">P${i+1}</div>
        <input id="name_${i}" placeholder="Player ${i+1} name" autocomplete="off">
      `;
      box.appendChild(row);

      const input = document.getElementById("name_" + i);
      if (prev[i] != null) input.value = prev[i];
    }
  }

  function startRound() {
    const n = parseInt($("players").value, 10);
    const selectedCats = getSelectedCategories();

    if (Number.isNaN(n) || n < 3 || n > 8) return alert("Choose 3–8 players.");
    if (selectedCats.length === 0) return alert("Pick at least 1 category.");

    // Ensure name boxes match player count right before starting
    generateNames(true);

    // Pick a random category from selected
    const chosenCat = selectedCats[rand(selectedCats.length)];
    const words = WORDS[chosenCat] || [];
    if (words.length < 2) return alert(`"${chosenCat}" needs at least 2 words.`);

    state.players = n;
    state.names = Array.from({length:n}, (_,i) => (document.getElementById("name_"+i)?.value || "").trim() || `Player ${i+1}`);
    state.chosenCategory = chosenCat;
    state.word = words[rand(words.length)];
    state.impostor = rand(n);
    state.first = rand(n);
    state.current = 0;
    state.holding = false;

    // ✅ NEW: read setting
    state.showCategoryToImpostor = $("showCatToImpostor").checked;

    hide("screen-setup");
    hide("screen-rules");
    hide("screen-final");
    show("screen-reveal");

    renderReveal();
  }

  function renderReveal() {
    $("playerBadge").textContent = `${state.names[state.current]} (${state.current+1}/${state.players})`;
    $("revealTitle").textContent = "Ready?";
    $("revealHint").textContent = "Press and hold to reveal. Release to hide.";

    hide("secretBox");
    $("hideBtn").disabled = true;

    $("secretSub").textContent = "";
    $("secretMain").textContent = "";
    $("secretNote").textContent = "";
  }

  function holdStart() {
    if (state.holding) return;
    state.holding = true;

    const cat = state.chosenCategory;
    const isImp = (state.current === state.impostor);

    show("secretBox");
    if (isImp) {
      // ✅ NEW: optionally show category to impostor
      $("secretSub").textContent = state.showCategoryToImpostor ? `Category: ${cat}` : "";
      $("secretMain").textContent = "You are the IMPOSTOR";
      $("secretNote").textContent = state.showCategoryToImpostor
        ? "You know the category. Blend in and figure out the word."
        : "Blend in and figure out the word.";
    } else {
      $("secretSub").textContent = `Category: ${cat}`;
      $("secretMain").textContent = state.word;
      $("secretNote").textContent = "Remember it, then release to hide.";
    }

    // ✅ bug fix: don't re-disable if already enabled; only run unlock delay if disabled
    if ($("hideBtn").disabled) {
      clearTimeout(state.holdTimer);
      state.holdTimer = setTimeout(() => {
        $("hideBtn").disabled = false;
      }, 400);
    }
  }

  function holdEnd() {
    if (!state.holding) return;
    state.holding = false;
    hide("secretBox");
    // (intentionally not clearing timeout)
  }

  function hidePass() {
    if ($("hideBtn").disabled) return;

    holdEnd();
    state.current++;

    if (state.current >= state.players) {
      hide("screen-reveal");
      show("screen-rules");
      $("firstSpeaker").textContent = state.names[state.first];
      return;
    }
    renderReveal();
  }

  function revealAnswer() {
    hide("screen-rules");
    show("screen-final");
    $("finalCategory").textContent = state.chosenCategory;
    $("finalWord").textContent = state.word;
    $("finalImpostor").textContent = state.names[state.impostor];
  }

  function backToSetup() {
    show("screen-setup");
    hide("screen-reveal");
    hide("screen-rules");
    hide("screen-final");
    holdEnd();
  }

  function playAgain() {
    startRound();
  }

  // EVENTS
  $("startBtn").addEventListener("click", startRound);
  $("hideBtn").addEventListener("click", hidePass);
  $("backBtn1").addEventListener("click", backToSetup);
  $("backBtn2").addEventListener("click", backToSetup);
  $("backBtn3").addEventListener("click", backToSetup);

  $("revealAnswerBtn").addEventListener("click", revealAnswer);
  $("playAgainBtn").addEventListener("click", playAgain);
  $("playAgainBtn2").addEventListener("click", playAgain);

  $("players").addEventListener("input", () => generateNames(true));
  $("minusBtn").addEventListener("click", () => {
  let v = parseInt($("players").value || "5", 10);
  v = Math.max(3, v - 1);
  $("players").value = v;
  generateNames(true);
  });

  $("plusBtn").addEventListener("click", () => {
  let v = parseInt($("players").value || "5", 10);
  v = Math.min(8, v + 1);
  $("players").value = v;
  generateNames(true);
  });
  const revealBtn = $("revealBtn");
  revealBtn.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    revealBtn.setPointerCapture?.(e.pointerId);
    holdStart();
  });
  revealBtn.addEventListener("pointerup", (e) => { e.preventDefault(); holdEnd(); });
  revealBtn.addEventListener("pointercancel", (e) => { e.preventDefault(); holdEnd(); });
  revealBtn.addEventListener("pointerleave", () => { holdEnd(); });

  // Boot
(async function boot() {
  // ✅ Always show player name boxes no matter what
  generateNames(false);

  try {
    await loadWordPacks();
    initCategories();
  } catch (err) {
    console.error(err);

    // Show a visible message instead of silently failing
    const box = $("categoryList");
    box.innerHTML = `
      <div class="muted">
        Couldn't load word packs.<br>
        Make sure <b>words.json</b> is in the repo root.
      </div>
    `;
  }
})();
</script>
</body>
</html>
